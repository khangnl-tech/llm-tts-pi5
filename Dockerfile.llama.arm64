# ===== builder (ARM64) =====
FROM arm64v8/debian:bookworm-slim AS builder
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates git build-essential cmake curl \
    libcurl4-openssl-dev pkg-config \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /opt
# Lấy source mới nhất (có thể thay --depth=1 để build nhanh)
RUN git clone https://github.com/ggml-org/llama.cpp
WORKDIR /opt/llama.cpp

# Quan trọng: ép cờ kiến trúc để bật dotprod + fp16 giống Pi 5 (ARMv8.2-A)
# và bật server + CURL (REST/OpenAI-compatible)
RUN cmake -S . -B build -G Ninja \
    -DLLAMA_BUILD_SERVER=ON \
    -DLLAMA_BUILD_EXAMPLES=OFF \
    -DLLAMA_CURL=ON \
    -DGGML_NATIVE=OFF \
    -DCMAKE_C_FLAGS='-O3 -march=armv8-a' \
    -DCMAKE_CXX_FLAGS='-O3 -march=armv8-a' \
 && cmake --build build -j

# ===== runtime (ARM64) =====
FROM arm64v8/debian:bookworm-slim AS runtime
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates libcurl4 \
 && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY --from=builder /opt/llama.cpp/build/bin/llama-server /usr/local/bin/llama-server
EXPOSE 10000
ENTRYPOINT ["/usr/local/bin/llama-server"]
